# 🌿 Smart Farm (스마트팜)

> **IoT 기반 임베디드 스마트팜 시스템**  
> STM32F411RE + FreeRTOS를 기반으로 센서, 액추에이터, LCD를 통합 제어하는 프로젝트  
> **팀원:** 유종민, 윤찬민  
> **발표일:** 2025.08.08

---

## 📑 프로젝트 개요

| 구분 | 내용 |
|------|------|
| **프로젝트명** | 스마트팜 (Smart Farm) |
| **목표** | 온습도, 수위, 팬, 펌프, 부저, RGB LED, LCD를 통합한 자동 제어 시스템 |
| **플랫폼** | STM32F411RE Nucleo 보드 |
| **운영체제** | FreeRTOS (멀티 태스크 스케줄링) |
| **핵심 기술** | ADC / PWM / I2C / Timer / GPIO 제어 및 실시간 태스크 관리 |

---

## 🧩 사용 부품

- **DHT11 온습도 센서**
- **수위 센서**
- **스텝 모터 (팬 역할)**
- **서보 모터 (펌프 역할)**
- **부저 (수위 알람)**
- **RGB LED (상태 표시)**
- **LCD 디스플레이**

---

## 흐름도
<img width="2655" height="1027" alt="image" src="https://github.com/user-attachments/assets/af1ad174-553c-4f60-a979-649eed7b57c9" />

---
## ⚙️ 주요 기능

1. **온습도 제어**
   - DHT11 센서 데이터(40bit = 16bit 온도 + 16bit 습도 + 8bit 체크섬) 읽기  
   - 10진 변환 후 LCD에 온습도 표시  
   - 온도 30℃ 이상 시 **스텝모터 속도 증가** (선풍기 동작 가정)

2. **수위 제어**
   - 수위 낮음: **서보모터 펌프** 작동 (부족 정도에 따라 2·3·4회 반복)  
   - 수위 높음: **부저 알람** 작동

3. **시각화**
   - RGB LED로 **시스템 전체 상태** 표시  
     - 🟢 정상 (정상 수위 & 30℃ 미만)  
     - 🟡 경계 (수위 낮음 또는 30~32℃)  
     - 🔴 경고 (수위 높음 또는 33℃ 이상)

4. **FreeRTOS 기반 태스크 제어**
   - 센서·LCD·펌프·팬 각각 독립 태스크로 구성  
   - **우선순위 조정으로 LCD 미갱신 문제 해결**

---

## 🧠 시스템 구조

```text
 ┌────────────────────────────┐
 │        Smart Farm          │
 ├────────────┬───────────────┤
 │ Sensors    │ Actuators     │
 │ DHT11      │ Step Motor (Fan) │
 │ WaterLevel │ Servo (Pump)  │
 └──────┬─────┴──────┬────────┘
        │             │
        ▼             ▼
   FreeRTOS Task   LCD / RGB / Buzzer
```
---

## 🧩 트러블슈팅 및 배운 점

### 1️⃣ FreeRTOS 태스크 우선순위 문제
- **현상:** 온습도 센서(DHT11) 값이 LCD에 갱신되지 않음  
- **원인:** 센서 태스크(Task)의 우선순위가 낮아 실행되지 않음  
- **해결:** `Task_DHT11`의 **우선순위를 Normal**로 변경하자 정상 작동  
- **배운 점:**  
  - FreeRTOS의 태스크는 실제로 **동시에 실행되는 것이 아니라 스케줄러에 의해 관리**된다.  
  - 우선순위가 적절하지 않으면 **핵심 태스크가 기아 상태(Starvation)** 에 빠질 수 있으며,  
    이는 시스템 오작동으로 이어질 수 있다.  
  - 실시간성을 요구하는 센서·디스플레이 루프는 **우선순위를 명확히 구분**해야 한다.



### 2️⃣ 스텝모터 속도 제어 문제
- **현상:** 팬(선풍기) 역할로 스텝모터를 사용했으나, **속도 조절이 불안정**함  
- **원인:** 실제 선풍기에는 **DC 모터**가 사용되지만, 스텝모터는 **정확한 각도 제어용**이라  
  PWM으로 단순 속도 제어가 불가능했음  
- **해결 과정:**  
  - 스텝모터는 **Idle In-traction Frequency / Idle Out-traction Frequency** 같은  
    “주파수 기반 제어” 개념을 사용해야 함  
  - 무작정 빠르게 펄스를 주면 모터가 토크를 잃고 회전이 멈춤  
  - 이를 위해 펄스 사이에 **적절한 딜레이(Delay)** 를 삽입하여 주파수를 조정함  
  - 아래 표를 참고하여 **모터가 무리 없이 회전 가능한 주파수 범위**를 확인함  

  | 항목 | 뜻 | 해석 |
  |------|------|------|
  | **Idle In-traction Frequency** | 회전 중인 모터가 지속 회전 가능한 최대 주파수 | 회전 중 600 Hz 이하의 펄스를 줘야 정상 동작 |
  | **Idle Out-traction Frequency** | 정지 상태에서 회전을 시작할 수 있는 최대 주파수 | 1000 Hz 이상에서는 모터가 초기 구동을 따라가지 못함 |

  - 900 μs(≈1111 Hz)는 `<1000 Hz` 조건을 만족하므로 **무리 없이 최대 속도로 회전 가능**한 설정으로 확인됨

- **배운 점:**  
  - 스텝모터의 속도는 “PWM 비율”이 아니라 “**펄스 간 주기(Delay)**”로 제어됨  
  - 단순 DC모터처럼 제어하려 하면 토크 손실과 진동이 발생함  
  - **스펙시트(데이터시트) 용어**를 정확히 이해하고,  
    “주파수/토크/가속 특성”을 기반으로 구동 파라미터를 설정해야 함

